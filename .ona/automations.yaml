version: 1

tasks:
  install-deps:
    description: Install dependencies for all repositories
    commands:
      - name: Install API dependencies
        command: cd /workspaces/workspaces/payments-api && npm install
      - name: Install UI dependencies
        command: cd /workspaces/workspaces/payments-ui && npm install
      - name: Install Worker dependencies
        command: cd /workspaces/workspaces/recon-worker && npm install

  migrate:
    description: Run database migrations
    commands:
      - name: Run migrations
        command: cd /workspaces/workspaces/payments-api && npm run migrate

  validate:
    description: Run end-to-end validation
    commands:
      - name: Run validation script
        command: cd /workspaces/workspaces/payments-api && npm run validate

services:
  postgres:
    description: PostgreSQL database
    command: docker run --rm --name payments-postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=payments -p 5432:5432 postgres:16-alpine
    readinessProbe:
      command: pg_isready -h localhost -p 5432 -U postgres
      initialDelaySeconds: 5
      periodSeconds: 2

  api:
    description: Payments API
    command: cd /workspaces/workspaces/payments-api && npm run dev
    env:
      PORT: "3001"
      PGHOST: localhost
      PGPORT: "5432"
      PGDATABASE: payments
      PGUSER: postgres
      PGPASSWORD: postgres
    dependsOn:
      - postgres
    readinessProbe:
      httpGet:
        path: /health
        port: 3001
      initialDelaySeconds: 5
      periodSeconds: 2

  ui:
    description: Payments UI
    command: cd /workspaces/workspaces/payments-ui && npm run dev
    env:
      NEXT_PUBLIC_API_URL: http://localhost:3001
    dependsOn:
      - api
    readinessProbe:
      httpGet:
        path: /
        port: 3000
      initialDelaySeconds: 10
      periodSeconds: 3

  worker:
    description: Reconciliation Worker
    command: cd /workspaces/workspaces/recon-worker && npm run dev
    env:
      PGHOST: localhost
      PGPORT: "5432"
      PGDATABASE: payments
      PGUSER: postgres
      PGPASSWORD: postgres
    dependsOn:
      - postgres
      - api
