tasks:
  install-deps:
    name: Install dependencies for all repositories
    command: |
      cd /workspaces/payments-api && npm install
      cd /workspaces/payments-ui && npm install
      cd /workspaces/recon-worker && npm install
    triggeredBy:
      - manual

  migrate:
    name: Run database migrations
    command: cd /workspaces/payments-api && npm run migrate
    triggeredBy:
      - manual

  validate:
    name: Run end-to-end validation
    command: cd /workspaces/payments-api && npm run validate
    triggeredBy:
      - manual

services:
  postgres:
    name: PostgreSQL database
    description: PostgreSQL database for payments system
    commands:
      start: |
        docker run --rm --name payments-postgres \
          -e POSTGRES_PASSWORD=postgres \
          -e POSTGRES_DB=payments \
          -p 5432:5432 \
          postgres:16-alpine
      ready: |
        docker exec payments-postgres pg_isready -U postgres
    triggeredBy:
      - postEnvironmentStart

  api:
    name: Payments API
    description: Payments API service
    commands:
      start: |
        cd /workspaces/payments-api
        echo "Waiting for dependencies to be installed..."
        timeout=60
        elapsed=0
        while [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-lock.json" ]; do
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for dependencies"
            exit 1
          fi
          sleep 2
          elapsed=$((elapsed + 2))
        done
        echo "Dependencies ready, starting API..."
        export PORT=3001
        export PGHOST=localhost
        export PGPORT=5432
        export PGDATABASE=payments
        export PGUSER=postgres
        export PGPASSWORD=postgres
        npm run dev
      ready: |
        curl -f http://localhost:3001/health
    triggeredBy:
      - postDevcontainerStart

  ui:
    name: Payments UI
    description: Payments UI frontend
    commands:
      start: |
        cd /workspaces/payments-ui
        echo "Waiting for dependencies to be installed..."
        timeout=60
        elapsed=0
        while [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-lock.json" ]; do
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for dependencies"
            exit 1
          fi
          sleep 2
          elapsed=$((elapsed + 2))
        done
        echo "Dependencies ready, starting UI..."
        # Get the public API URL from Gitpod
        API_URL=$(gitpod environment port open 3001 --name "Payments API" 2>/dev/null || echo "http://localhost:3001")
        export NEXT_PUBLIC_API_URL=$API_URL
        echo "Using API URL: $NEXT_PUBLIC_API_URL"
        npm run dev
      ready: |
        curl -f http://localhost:3000/
    triggeredBy:
      - postDevcontainerStart

  worker:
    name: Reconciliation Worker
    description: Background worker for reconciliation
    commands:
      start: |
        cd /workspaces/recon-worker
        echo "Waiting for dependencies to be installed..."
        timeout=60
        elapsed=0
        while [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-lock.json" ]; do
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for dependencies"
            exit 1
          fi
          sleep 2
          elapsed=$((elapsed + 2))
        done
        echo "Dependencies ready, starting worker..."
        export PGHOST=localhost
        export PGPORT=5432
        export PGDATABASE=payments
        export PGUSER=postgres
        export PGPASSWORD=postgres
        npm run dev
      ready: |
        echo "Worker is ready"
        exit 0
    triggeredBy:
      - postDevcontainerStart
